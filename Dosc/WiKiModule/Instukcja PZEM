 INSTRUKCJA: PZEM-004T v3.0 na ESP32-S3
Aby PZEM dziaa stabilnie, pokazywa napicie/prd i mruga diodami, musisz speni 3 偶elazne zasady:

1. ZASADA SPRZTOWA (Pinologia i Zasilanie)
To tu le偶a g贸wny problem. ESP32-S3 jest specyficzne.

ZAKAZANE PINY: Nigdy nie u偶ywaj pin贸w GPIO 10, 11, 12 do komunikacji z PZEM. Na ESP32-S3 s one wewntrznie poczone z pamici Flash. U偶ycie ich zawiesi procesor lub zablokuje komunikacj (dlatego diody nie mrugay).

BEZPIECZNE PINY: U偶ywaj niskich numer贸w GPIO, np. 4 i 5 (chyba 偶e masz tam I2C).

KRZY呕OWE POCZENIE (RX/TX): Musisz poczy to na krzy偶:

ESP32 TX (Pin 5) ---> idzie do PZEM RX

ESP32 RX (Pin 4) ---> idzie do PZEM TX

ZASILANIE 230V: Modu PZEM nie wyle 偶adnych danych, jeli nie jest podczony do sieci 230V (nawet jeli ma zasilanie 5V z pytki). Cz pomiarowa musi "czu" sie.

ZASILANIE 5V: PZEM wymaga 5V VCC. Na 3.3V nie zadziaa stabilnie.

2. ZASADA PROGRAMOWA (Biblioteki i HardwareSerial)
Zapomnij o SoftwareSerial na ESP32. S3 ma pot偶ne sprztowe porty UART.

Wymagana Biblioteka:
U偶ywaj sprawdzonej biblioteki Mandulaj. W platformio.ini:

Ini, TOML
lib_deps =
    mandulaj/PZEM-004T-v30 @ ^1.1.2
Klucz do sukcesu w kodzie:
Nie pozw贸l bibliotece zgadywa pin贸w. Utw贸rz wasny obiekt HardwareSerial, zainicjuj go rcznie i przeka偶 do PZEM.

SZABLON KODU (Kopiuj-Wklej):

C++
#include <HardwareSerial.h>
#include <PZEM004Tv30.h>

// 1. Definicja Pin贸w (SPRAWDZONE NA S3)
#define PZEM_RX_PIN 4  // Do TX moduu
#define PZEM_TX_PIN 5  // Do RX moduu

// 2. Tworzymy obiekt Seriala Sprztowego (UART 2)
HardwareSerial PzemSerial(2);

// 3. Przekazujemy go do biblioteki PZEM
PZEM004Tv30 pzem(PzemSerial, PZEM_RX_PIN, PZEM_TX_PIN);

void setup() {
    Serial.begin(115200);
    
    // 4. MAGIA: Rczny start portu przed u偶yciem biblioteki
    // To wymusza na ESP32-S3 poprawne zmapowanie pin贸w!
    PzemSerial.begin(9600, SERIAL_8N1, PZEM_RX_PIN, PZEM_TX_PIN);
    delay(100); 

    Serial.println("PZEM Start...");
}

void loop() {
    // 5. Odczyt (co ok. 1-2 sekundy, nie czciej!)
    static unsigned long lastTime = 0;
    if (millis() - lastTime > 1000) {
        lastTime = millis();
        
        float v = pzem.voltage();
        float i = pzem.current();
        
        // 6. Obsuga bd贸w (BARDZO WA呕NE)
        if (isnan(v)) {
            Serial.println("Bd odczytu! (Sprawd藕 czy jest 230V i czy RX/TX s ok)");
        } else {
            Serial.printf("Napicie: %.1fV, Prd: %.3fA\n", v, i);
        }
    }
}
3. ZASADA DIAGNOSTYCZNA (Co m贸wi diody?)
Patrz na mae diody SMD na zielonej pytce PZEM. One m贸wi prawd:

Dioda RX (na module PZEM): Powinna mruga cyklicznie (np. co sekund).

Co to znaczy: Modu dostaje zapytanie od ESP32 ("Hej, daj napicie!").

Jeli nie mruga: Masz 藕le zdefiniowany pin TX w kodzie lub u偶ywasz zakazanych pin贸w (10/11).

Dioda TX (na module PZEM): Powinna mruga zaraz po diodzie RX.

Co to znaczy: Modu odpowiada ("Prosz, oto wyniki").

Jeli nie mruga: Modu nie ma zasilania 230V lub jest uszkodzony.

Obie mrugaj, ale w kodzie NaN:

Ze poczenie zwrotne (kabel TX moduu -> RX ESP).

Bd adresu (trzeba u偶y pzem.setAddress(0x01) w setupie raz, 偶eby zresetowa).
